<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exams & Results</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .grade-pill { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .grade-A { background: #dcfce7; color: #166534; }
        .grade-B { background: #fef9c3; color: #854d0e; }
        .grade-F { background: #fee2e2; color: #991b1b; }
        @media print { .sidebar, .top-bar, .controls, .btn-primary { display: none !important; } .card { border: none; box-shadow: none; } }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar" id="sidebar-container"></nav>

        <main class="main-content">
            <div class="top-bar">
                <h1>Exams & Results</h1>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Report</button>
            </div>

            <div class="grid controls" style="grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>Exam Type</label>
                    <select id="examType" class="form-control">
                        <option value="Final Term">Final Term</option>
                        <option value="Mid Term">Mid Term</option>
                        <option value="Monthly Test">Monthly Test</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Class</label>
                    <select id="classSelect" class="form-control" onchange="loadStudentsForExam()"></select>
                </div>
                <div class="form-group">
                    <label>Subject</label>
                    <select id="subjectSelect" class="form-control">
                        <option value="Mathematics">Mathematics</option>
                        <option value="Science">Science</option>
                        <option value="English">English</option>
                        <option value="History">History</option>
                    </select>
                </div>
                <button class="btn btn-primary" style="height: 42px; align-self: flex-end;" onclick="saveAllMarks()">üíæ Save All Marks</button>
            </div>

            <div class="card">
                <h3>Mark Entry Sheet</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Marks (Out of 100)</th>
                            <th>Grade</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="examTableBody">
                        <tr><td colspan="4" style="text-align:center">Select a class to enter marks.</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        const EXAM_KEY = 'sms_exams';

        // 1. Initial Load
        async function initExams() {
            const classes = await api.get('sms_classes');
            const select = document.getElementById('classSelect');
            select.innerHTML = '<option value="">-- Select Class --</option>' + 
                classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        // 2. Load Students and existing marks
        async function loadStudentsForExam() {
            const className = document.getElementById('classSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const examType = document.getElementById('examType').value;
            
            if(!className) return;

            const students = await api.get(DB_KEYS.STUDENTS);
            const filteredStudents = students.filter(s => s.class === className);
            
            // Get existing marks
            const allExams = await api.get(EXAM_KEY);
            const marksData = allExams.find(e => e.class === className && e.subject === subject && e.type === examType)?.marks || {};

            const tbody = document.getElementById('examTableBody');
            tbody.innerHTML = filteredStudents.map(s => {
                const score = marksData[s.id] || '';
                return `
                    <tr data-student-id="${s.id}">
                        <td><strong>${s.name}</strong></td>
                        <td>
                            <input type="number" class="form-control mark-input" 
                                   value="${score}" min="0" max="100" style="width: 80px;"
                                   oninput="updateRowGrade(this)">
                        </td>
                        <td class="grade-cell">${calculateGrade(score)}</td>
                        <td class="status-cell">${score >= 40 ? '‚úÖ Pass' : '‚ùå Fail'}</td>
                    </tr>
                `;
            }).join('');
        }

        // 3. Auto-Grade Logic
        function calculateGrade(marks) {
            if (marks === '') return '-';
            const m = parseInt(marks);
            if (m >= 90) return '<span class="grade-pill grade-A">A+</span>';
            if (m >= 80) return '<span class="grade-pill grade-A">A</span>';
            if (m >= 70) return '<span class="grade-pill grade-B">B</span>';
            if (m >= 60) return '<span class="grade-pill grade-B">C</span>';
            if (m >= 50) return '<span class="grade-pill grade-B">D</span>';
            return '<span class="grade-pill grade-F">F</span>';
        }

        function updateRowGrade(input) {
            const row = input.closest('tr');
            const score = input.value;
            row.querySelector('.grade-cell').innerHTML = calculateGrade(score);
            row.querySelector('.status-cell').innerText = score >= 40 ? '‚úÖ Pass' : '‚ùå Fail';
        }

        // 4. Save Logic
        async function saveAllMarks() {
            const className = document.getElementById('classSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const examType = document.getElementById('examType').value;
            const rows = document.querySelectorAll('#examTableBody tr');
            
            const marks = {};
            rows.forEach(row => {
                const id = row.dataset.studentId;
                const score = row.querySelector('.mark-input').value;
                if(id) marks[id] = score;
            });

            const allExams = await api.get(EXAM_KEY);
            const index = allExams.findIndex(e => e.class === className && e.subject === subject && e.type === examType);

            const examEntry = { class: className, subject, type: examType, marks };

            if(index > -1) allExams[index] = examEntry;
            else allExams.push(examEntry);

            localStorage.setItem(EXAM_KEY, JSON.stringify(allExams));
            alert('Marks saved successfully!');
        }

        initExams();
    </script>
</body>
</html>