<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Students</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="app-container">
    <nav class="sidebar" id="sidebar-container"></nav>

    <main class="main-content">
      <div class="top-bar">
        <h1>Student Management</h1>
        <div class="flex" style="gap: 10px">
          <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search students...">
          </div>
          <button class="btn btn-primary" onclick="openModal()">+ Add Student</button>
        </div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Class</th>
              <th>Fees</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="studentsTable"></tbody>
        </table>
      </div>
    </main>
  </div>

  <div id="studentModal" class="modal hidden">
    <div class="modal-content">
      <h2 id="modalTitle">Add Student</h2>
      <br>
      <form id="studentForm">
        <input type="hidden" id="studentId">
        
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="name" class="form-control" required>
        </div>

        <div class="form-group">
          <label>Assign Class</label>
          <select id="classSelect" class="form-control" required>
            <option value="">-- Select Class --</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fees Status</label>
          <select id="fees" class="form-control">
            <option value="Paid">Paid</option>
            <option value="Unpaid">Unpaid</option>
          </select>
        </div>

        <div class="flex" style="justify-content: flex-end; gap: 10px;">
          <button type="button" class="btn" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Student</button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/app.js"></script>

  <script>
    const tableBody = document.getElementById('studentsTable');
    const modal = document.getElementById('studentModal');
    const form = document.getElementById('studentForm');
    const classDropdown = document.getElementById('classSelect');

    // 1. POPULATE CLASSES DROPDOWN (The missing piece)
    async function populateClasses() {
      // Assuming your classes are stored under 'sms_classes' or similar
      const classes = await api.get('sms_classes') || [];
      classDropdown.innerHTML = '<option value="">-- Select Class --</option>';
      
      classes.forEach(c => {
        const option = document.createElement('option');
        option.value = c.name; 
        option.textContent = c.name;
        classDropdown.appendChild(option);
      });
    }

    // 2. LOAD STUDENTS
    async function loadStudents(query = '') {
      let students = await api.get(DB_KEYS.STUDENTS);
      if (query) {
        students = students.filter(s => s.name.toLowerCase().includes(query.toLowerCase()));
      }

      tableBody.innerHTML = students.map(s => `
        <tr>
          <td>#${s.id}</td>
          <td><strong>${s.name}</strong></td>
          <td><span class="badge" style="background:var(--bg-body)">${s.class || 'No Class'}</span></td>
          <td><span class="badge ${s.fees === 'Paid' ? 'active' : 'inactive'}">${s.fees}</span></td>
          <td>
            <button class="btn" onclick="editStudent(${s.id})">‚úèÔ∏è</button>
            <button class="btn" onclick="deleteStudent(${s.id})" style="color:var(--danger)">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    // 3. ADD / EDIT SUBMIT
    async function handleFormSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('studentId').value;
      const data = {
        name: document.getElementById('name').value,
        class: classDropdown.value, // Uses the select value
        fees: document.getElementById('fees').value,
        status: 'Active'
      };

      if (id) {
        await api.put(DB_KEYS.STUDENTS, id, data);
        UI.showToast('Student updated successfully');
      } else {
        await api.post(DB_KEYS.STUDENTS, data);
        UI.showToast('Student added successfully');
      }
      closeModal();
      loadStudents();
    }

    // 4. MODAL CONTROL
    window.openModal = async () => {
      form.reset();
      await populateClasses(); // Load classes every time modal opens
      document.getElementById('studentId').value = '';
      document.getElementById('modalTitle').innerText = 'Add Student';
      modal.classList.remove('hidden');
    };

    window.closeModal = () => modal.classList.add('hidden');

    window.editStudent = async (id) => {
      const students = await api.get(DB_KEYS.STUDENTS);
      const student = students.find(s => s.id == id);

      await populateClasses(); // Ensure list is loaded
      
      document.getElementById('studentId').value = student.id;
      document.getElementById('name').value = student.name;
      classDropdown.value = student.class; // Set the saved class
      document.getElementById('fees').value = student.fees;
      document.getElementById('modalTitle').innerText = 'Edit Student';

      modal.classList.remove('hidden');
    };

    window.deleteStudent = async (id) => {
      if (confirm('Are you sure you want to delete this student?')) {
        await api.delete(DB_KEYS.STUDENTS, id);
        UI.showToast('Student deleted', 'danger');
        loadStudents();
      }
    };

    // EVENT LISTENERS
    form.addEventListener('submit', handleFormSubmit);
    document.getElementById('searchInput').addEventListener('input', (e) => loadStudents(e.target.value));

    // INITIAL LOAD
    loadStudents();
  </script>
</body>
</html>